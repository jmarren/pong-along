
#include <SDL3/SDL_events.h>
#include <SDL3/SDL_keyboard.h>
#include <SDL3/SDL_oldnames.h>
#include <SDL3/SDL_rect.h>
#include "../client.h"
#include "../view/text.h"
#include "../net/tcp.h"

#define HEIGHT 10
#define WIDTH 1000
#define FR_MARGIN_LEFT 100
#define FR_MARGIN_TOP 100

// title 
#define TITLE_Y 100
#define TITLE_X LEFT_ALIGN
#define TITLE_W 1000
#define TITLE_H 10
#define TITLE_TEXT "enter your username"

// text input
#define TEXT_INPUT_X FR_MARGIN_LEFT
#define TEXT_INPUT_Y TITLE_Y + 10

// title rect
SDL_FRect title_rect = (SDL_FRect){
		.x = FR_MARGIN_LEFT,
		.y = FR_MARGIN_TOP,
		.w = WIDTH,
		.h = HEIGHT,
};

// text_input rect
SDL_FRect text_input_rect = (SDL_FRect){
		.x = FR_MARGIN_LEFT,
		.y = FR_MARGIN_TOP + TITLE_H,
		.w = WIDTH,
		.h = HEIGHT,
};

// initialize text input component
void init_text_input(fr_enter_username* frame) {
	string input_text = create_string();
	set_string(&input_text, "");
	frame->input_component = (text_component){
		.rect = text_input_rect,
		.text = input_text,
	};
}

// initialize text input
void init_title(fr_enter_username* frame) {
	string title_text = create_string();
	set_string(&title_text, TITLE_TEXT);
	frame->title_component = (text_component){
		.rect = title_rect,
		.text = title_text,
	};
	
}



void handle_backspace(fr_enter_username* frame) {
	string_truncate(&frame->input_component.text);
}

void handle_return(App* app) {
	// stop taking input
	SDL_StopTextInput(app->window);

	// copy text_input to username
	strncpy(app->username, app->frames.enter_username.input_component.text.base, 100);

	// set game phase to pointing
	app->current_frame = choosing_opponent;
	//
	tcp_write_msg_1("username", app->username);

	tcp_write_msg_1("query", "players");
}

void handle_text_input(fr_enter_username* frame, SDL_Event* event) {
	printf("&frame->input_component.text = %s\n", frame->input_component.text.base);
	append_string(&frame->input_component.text, (char*)event->text.text);
}


void enter_username_init(App* app) {
	fr_enter_username* fr = &(app->frames.enter_username);
	SDL_StartTextInput(app->window);
	init_text_input(fr);
	init_title(fr);
}


void enter_username_input(App* app, SDL_Event* event) {
	
	fr_enter_username* fr = &(app->frames.enter_username);

	if (event->type == SDL_EVENT_KEY_DOWN) {
		SDL_Keycode key = event->key.key;

		switch (key) {
			case SDLK_BACKSPACE:
				handle_backspace(fr);
				break;
			case SDLK_RETURN:
				handle_return(app);
				break;
		}
	}
	if (event->type == SDL_EVENT_TEXT_INPUT) {
			handle_text_input(fr,event);
	}
}



void enter_username_render(App* app) {
	SDL_Renderer* renderer = app->renderer;
	SDL_SetRenderDrawColor(renderer, 0, 0, 0, 255);
	SDL_RenderClear(renderer);
	SDL_SetRenderDrawColor(renderer, 255, 255, 255, 255);

	text_render(app, &(app->frames.enter_username.title_component));
	text_render(app, &(app->frames.enter_username.input_component));
}

